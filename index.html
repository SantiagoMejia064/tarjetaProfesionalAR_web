<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <!-- Componente de suavizado -->
    <script>
      AFRAME.registerComponent('smooth-move', {
        schema: {
          speed: { type: 'number', default: 0.01 }  <!-- Velocidad ajustada para minimizar el temblor -->
        },

        init: function () {
          this.targetPosition = new THREE.Vector3();  // Usaremos este vector para calcular el objetivo
          this.currentPosition = new THREE.Vector3(); // La posición actual del objeto
        },

        tick: function () {
          // Obtener la posición actual del objeto
          let position = this.el.object3D.position;

          // Si la posición de seguimiento ha cambiado, actualizar la posición objetivo
          if (this.targetPosition.distanceTo(position) > 0.01) {
            this.currentPosition.lerp(this.targetPosition, this.data.speed); // Suavizar el movimiento
            position.copy(this.currentPosition); // Aplicar la nueva posición suavizada
          }
        },

        update: function () {
          // Aquí actualizamos la posición objetivo a la nueva posición cuando cambia
          this.targetPosition.copy(this.el.object3D.position);
        }
      });
    </script>
  </head>

  <body>
    <a-scene
      mindar-image="imageTargetSrc: assets/targets.mind; trackingFrequency: 60;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      embedded
    >
      <a-assets>
        <img id="card" src="assets/Paola Sanchez.jpg" />
        <img id="iconReset" src="assets/iconoReset.png" />
        <img id="iconPlay" src="assets/iconoPlay.png" />
        <video id="video1" src="assets/video1.mp4" loop playsinline preload="auto" crossorigin="anonymous"></video>
        <video id="video2" src="assets/video2.mp4" loop playsinline preload="auto" crossorigin="anonymous"></video>
      </a-assets>

      <!-- Mantener la cámara para visión en dispositivos horizontales -->
      <a-camera position="0 0 0" look-controls="enabled: false" fov="80"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" smooth-move="speed: 0.01" visible="true">
        <!-- Tarjeta principal con suavizado -->
        <a-plane src="#card" width="1.0" height="0.6" position="0 0 0" material="side: double"></a-plane>

        <!-- Nuevo botón: Registrate aquí -->
        <a-plane
          id="btnRegister"
          color="#ffffff"
          width="0.9"
          height="0.12"
          position="0 -0.45 0.01"
          material="side: double"
        >
          <a-text value="REGISTRATE AQUI / REGISTER HERE" align="center" scale="0.2 0.2 0.2" color="#A69886" font="dejavu"></a-text>
        </a-plane>

        <!-- Nuevo botón: Ir a Instagram -->
        <a-plane
          id="btnInstagram"
          color="#ffffff"
          width="0.6"
          height="0.12"
          position="-0.27 -0.6 0.01"
          material="side: double"
        >
          <a-text value="SIGUENOS EN INSTAGRAM" align="center" scale="0.2 0.2 0.2" color="#A69886" font="dejavu"></a-text>
        </a-plane>

        <!-- Botón WEB -->
        <a-plane id="btn" color="#ffffff" width="0.5" height="0.12" position="0.32 -0.6 0.01" material="side: double">
          <a-text value="VISITA NUESTRA WEB" align="center" scale="0.2 0.2 0.2" color="#A69886" font="dejavu"></a-text>
        </a-plane>

        <!-- =========================
            BLOQUE VIDEO 1 (IZQUIERDA)
            ========================= -->
        <a-video id="vid1" src="#video1" width="0.6" height="1.0" position="-0.9 0 0.01" material="side: double"></a-video>

        <!-- Botones debajo del video 1 -->
        <a-circle id="btnV1" color="#BFA980" radius="0.06" width="0.12" height="0.12" position="-0.98 -0.58 0.02" material="side: double">
          <a-image src="#iconPlay" width="0.15" height="0.15" position="0.009 0 0.01"></a-image>
        </a-circle>

        <a-circle id="btnR1" color="#BFA980" radius="0.06" width="0.12" height="0.12" position="-0.83 -0.58 0.02" material="side: double">
          <a-image src="#iconReset" width="0.08" height="0.08" position="0 0 0.01"></a-image>
        </a-circle>

        <!-- =========================
            BLOQUE VIDEO 2 (DERECHA)
            ========================= -->
        <a-video id="vid2" src="#video2" width="0.6" height="1.0" position="0.9 0 0.01" material="side: double"></a-video>

        <!-- Botones debajo del video 2 -->
        <a-circle id="btnV2" color="#BFA980" radius="0.06" width="0.45" height="0.12" position="0.83 -0.58 0.02" material="side: double">
          <a-image src="#iconPlay" width="0.15" height="0.15" position="0.0 0 0.01"></a-image>
        </a-circle>

        <a-circle id="btnR2" color="#BFA980" radius="0.06" width="0.12" height="0.12" position="0.98 -0.58 0.02" material="side: double">
          <a-image src="#iconReset" width="0.08" height="0.08" position="0 0 0.01"></a-image>
        </a-circle>

      </a-entity>
    </a-scene>

    <script>
      const IG = "https://www.instagram.com/paolasanchez_ortodoncia/";
      const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSfQi4iy42Rf00xZrCHNl3PLo1dYFF1NBe8McPPeC7rsFXCu7g/viewform?usp=header";
      const v1 = document.getElementById("video1");
      const v2 = document.getElementById("video2");

      const btnV1 = document.getElementById("btnV1");
      const btnV2 = document.getElementById("btnV2");
      const lblV1 = document.getElementById("lblV1");
      const lblV2 = document.getElementById("lblV2");

      const btnR1 = document.getElementById("btnR1");
      const btnR2 = document.getElementById("btnR2");

      const btnRegister = document.getElementById("btnRegister");
      const btnInstagram = document.getElementById("btnInstagram");

      let debounceTimeout = null; // Variable para almacenar el timeout del debounce

      // Inicia todo en pausa
      v1.pause(); v2.pause();

      const playV1 = async () => { 
        if (debounceTimeout) return; // Si ya hay un timeout, no hacer nada
        debounceTimeout = setTimeout(() => { debounceTimeout = null; }, 500); // Esperar 500ms antes de permitir otro clic
        await v1.play().catch(()=>{}); v2.pause(); lblV1.setAttribute("value","Pausar"); lblV2.setAttribute("value","Reproducir"); 
      };
      const pauseV1 = () => { 
        if (debounceTimeout) return; // Si ya hay un timeout, no hacer nada
        debounceTimeout = setTimeout(() => { debounceTimeout = null; }, 500); // Esperar 500ms antes de permitir otro clic
        v1.pause(); lblV1.setAttribute("value","Reproducir"); 
      };
      const playV2 = async () => { 
        if (debounceTimeout) return; // Si ya hay un timeout, no hacer nada
        debounceTimeout = setTimeout(() => { debounceTimeout = null; }, 500); // Esperar 500ms antes de permitir otro clic
        await v2.play().catch(()=>{}); v1.pause(); lblV2.setAttribute("value","Pausar"); lblV1.setAttribute("value","Reproducir"); 
      };
      const pauseV2 = () => { 
        if (debounceTimeout) return; // Si ya hay un timeout, no hacer nada
        debounceTimeout = setTimeout(() => { debounceTimeout = null; }, 500); // Esperar 500ms antes de permitir otro clic
        v2.pause(); lblV2.setAttribute("value","Reproducir"); 
      };

      const restartV1 = () => { 
        if (debounceTimeout) return; // Si ya hay un timeout, no hacer nada
        debounceTimeout = setTimeout(() => { debounceTimeout = null; }, 500); // Esperar 500ms antes de permitir otro clic
        v1.currentTime = 0; v1.play().catch(()=>{}); v2.pause(); lblV1.setAttribute("value","Pausar"); lblV2.setAttribute("value","Reproducir"); 
      };
      const restartV2 = () => { 
        if (debounceTimeout) return; // Si ya hay un timeout, no hacer nada
        debounceTimeout = setTimeout(() => { debounceTimeout = null; }, 500); // Esperar 500ms antes de permitir otro clic
        v2.currentTime = 0; v2.play().catch(()=>{}); v1.pause(); lblV2.setAttribute("value","Pausar"); lblV1.setAttribute("value","Reproducir"); 
      };

      // Redirigir al formulario al hacer clic en el botón "Registrate aquí"
      btnRegister.addEventListener("click", () => {
        window.open(FORM_URL, "_blank");
      });

      btnInstagram.addEventListener("click", () => {
        window.open(IG, "_blank");
      });

      // Raycast manual: web / v1 / v2 / r1 / r2
      AFRAME.registerComponent("screen-click-handler",{
        init(){
          const scene=this.el.sceneEl;
          this.canvas=scene.renderer.domElement; this.camera=scene.camera;
          const targets=[{el:btn,id:"web"},{el:btnV1,id:"v1"},{el:btnV2,id:"v2"},{el:btnR1,id:"r1"},{el:btnR2,id:"r2"},{el:btnRegister,id:"register"},{el:btnInstagram,id:"instagram"}];
          targets.forEach(t=>t.obj3D=t.el.object3D);
          const ray=new THREE.Raycaster(); const p=new THREE.Vector2();

          const onPointer=(ev)=>{
            const touch=ev.type.startsWith("touch");
            const x=touch?ev.touches[0].clientX:ev.clientX;
            const y=touch?ev.touches[0].clientY:ev.clientY;
            const r=this.canvas.getBoundingClientRect();
            p.x=((x-r.left)/r.width)*2-1; p.y=-(((y-r.top)/r.height)*2-1);
            ray.setFromCamera(p,this.camera);
            const hits=ray.intersectObjects(targets.map(t=>t.obj3D),true);
            if(!hits.length)return;
            const hit=hits[0].object;
            const target=targets.find(t=>t.obj3D===hit||t.obj3D.children.includes(hit)||t.obj3D.children.some(c=>c===hit||c.children.includes(hit)));
            if(!target)return;

            if(target.id==="web"){ window.open("https://paolasanchezortodoncia.com","_blank")||window.location.assign("https://paolasanchezortodoncia.com"); return; }
            if(target.id==="v1"){ v1.paused ? playV1() : pauseV1(); return; }
            if(target.id==="v2"){ v2.paused ? playV2() : pauseV2(); return; }
            if(target.id==="r1"){ restartV1(); return; }
            if(target.id==="r2"){ restartV2(); return; }
            if(target.id==="register"){ window.open(FORM_URL, "_blank"); return; }
            if(target.id==="instagram"){ window.open(IG, "_blank"); return; }
          };

          window.addEventListener("click",onPointer,{passive:true});
          window.addEventListener("touchstart",onPointer,{passive:true});
        }
      });

      document.querySelector("a-scene").setAttribute("screen-click-handler","");
    </script>
  </body>
</html>
